<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <!-- Product Definition -->
  <Package Name="Octofleet Node Agent"
           Manufacturer="Octofleet"
           Version="0.5.1"
           UpgradeCode="E8F9D4A2-7B3C-4E5F-9A1D-2C6B8F0E3D7A"
           Scope="perMachine">

    <!-- Media Definition -->
    <MediaTemplate EmbedCab="yes" />

    <!-- Major Upgrade: Remove older versions -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                  Schedule="afterInstallInitialize" />

    <!-- Custom Properties (can be set via command line) -->
    <Property Id="GATEWAY_URL" Value="" />
    <Property Id="GATEWAY_TOKEN" Value="" Secure="yes" />
    <Property Id="INVENTORY_URL" Value="" />
    <Property Id="DISPLAY_NAME" Value="" />
    <Property Id="AUTOSTART_HELPER" Value="1" />

    <!-- Installation Directory -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="Octofleet">
        <Directory Id="AGENTFOLDER" Name="Agent" />
      </Directory>
    </StandardDirectory>

    <!-- CommonAppData for Config -->
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="CONFIGDIR" Name="Octofleet" />
    </StandardDirectory>

    <!-- Feature: Main Agent -->
    <Feature Id="MainFeature" Title="Octofleet Node Agent" Level="1">
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="ScreenHelperComponents" />
      <ComponentGroupRef Id="ConfigComponents" />
    </Feature>

  </Package>

  <!-- Service Components -->
  <Fragment>
    <ComponentGroup Id="ServiceComponents" Directory="AGENTFOLDER">
      
      <!-- Main Service Executable -->
      <Component Id="ServiceExe" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
        <File Id="OctofleetAgentServiceExe"
              Source="$(var.OctofleetAgent.Service.TargetDir)OctofleetAgent.Service.exe"
              KeyPath="yes" />
        
        <!-- Install as Windows Service -->
        <ServiceInstall Id="ServiceInstaller"
                        Name="OctofleetNodeAgent"
                        DisplayName="Octofleet Node Agent"
                        Description="Octofleet endpoint management agent - connects to Gateway for remote management and inventory collection"
                        Type="ownProcess"
                        Start="auto"
                        ErrorControl="normal"
                        Account="LocalSystem" />
        
        <!-- Service Control: Start after install, Stop before uninstall -->
        <ServiceControl Id="ServiceControl"
                        Name="OctofleetNodeAgent"
                        Start="install"
                        Stop="both"
                        Remove="uninstall"
                        Wait="yes" />
      </Component>

      <!-- All other DLLs and dependencies -->
      <Component Id="ServiceDependencies" Guid="B2C3D4E5-F6A7-8901-BCDE-F23456789012">
        <File Source="$(var.OctofleetAgent.Service.TargetDir)*.dll" />
        <File Source="$(var.OctofleetAgent.Service.TargetDir)*.json" />
      </Component>

    </ComponentGroup>
  </Fragment>

  <!-- Screen Helper Components -->
  <Fragment>
    <ComponentGroup Id="ScreenHelperComponents" Directory="AGENTFOLDER">
      
      <!-- Screen Helper Executable -->
      <Component Id="ScreenHelperExe" Guid="F1E2D3C4-B5A6-9807-6543-210FEDCBA987">
        <File Id="OctofleetScreenHelperExe"
              Source="$(var.OctofleetScreenHelper.TargetDir)OctofleetScreenHelper.exe"
              KeyPath="yes" />
      </Component>

      <!-- Auto-Start Registry Entry (per-user, runs at login) -->
      <Component Id="ScreenHelperAutoStart" Guid="A9B8C7D6-E5F4-3210-9876-543210FEDCBA">
        <Condition>AUTOSTART_HELPER = "1"</Condition>
        <RegistryValue Root="HKLM"
                       Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
                       Name="OctofleetScreenHelper"
                       Type="string"
                       Value="&quot;[AGENTFOLDER]OctofleetScreenHelper.exe&quot;"
                       KeyPath="yes" />
      </Component>

    </ComponentGroup>
  </Fragment>

  <!-- Config Components -->
  <Fragment>
    <ComponentGroup Id="ConfigComponents" Directory="CONFIGDIR">
      
      <!-- Create config directory -->
      <Component Id="ConfigDirectory" Guid="C3D4E5F6-A7B8-9012-CDEF-345678901234">
        <CreateFolder />
      </Component>

      <!-- Create logs subdirectory -->
      <Component Id="LogsDirectory" Guid="D4E5F6A7-B8C9-0123-DEF0-456789012345">
        <CreateFolder Directory="CONFIGDIR">
          <util:PermissionEx User="Everyone" GenericAll="yes" />
        </CreateFolder>
      </Component>

    </ComponentGroup>
  </Fragment>

  <!-- Custom Action for Config File Creation -->
  <Fragment>
    <Binary Id="CustomActionDll" SourceFile="CustomActions.CA.dll" />
    
    <CustomAction Id="WriteConfigFile"
                  BinaryRef="CustomActionDll"
                  DllEntry="WriteConfigFile"
                  Execute="deferred"
                  Impersonate="no" />
    
    <CustomAction Id="SetConfigProperties"
                  Property="WriteConfigFile"
                  Value="GATEWAY_URL=[GATEWAY_URL];GATEWAY_TOKEN=[GATEWAY_TOKEN];INVENTORY_URL=[INVENTORY_URL];DISPLAY_NAME=[DISPLAY_NAME];CONFIGDIR=[CONFIGDIR]" />

    <InstallExecuteSequence>
      <Custom Action="SetConfigProperties" Before="WriteConfigFile">
        GATEWAY_URL &lt;&gt; "" OR GATEWAY_TOKEN &lt;&gt; ""
      </Custom>
      <Custom Action="WriteConfigFile" Before="StartServices">
        GATEWAY_URL &lt;&gt; "" OR GATEWAY_TOKEN &lt;&gt; ""
      </Custom>
    </InstallExecuteSequence>
  </Fragment>

</Wix>
